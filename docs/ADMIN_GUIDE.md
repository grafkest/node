# Административная инструкция

## Назначение документа
Руководство описывает задачи администрирования системы визуализации доменных графов: от развертывания окружения до сопровождения данных, обновлений и безопасности. Документ рассчитан на DevOps-инженеров, администраторов и владельцев данных, отвечающих за бесперебойную работу решения. 【F:README.md†L17-L79】

## Архитектура решения
- **Фронтенд** — одностраничное приложение на Vite + React. Отвечает за визуализацию графа, формы редактирования и аналитические панели. Подключает библиотеки Consta UI/Charts и компонент `react-force-graph-2d` для рендеринга графа. 【F:src/App.tsx†L1-L170】【F:src/components/GraphView.tsx†L15-L156】
- **Сервис хранения** — Express-приложение (`npm run server`), использующее sql.js для хранения снапшотов в файле `data/graph.db`. Предоставляет REST API для загрузки графов, сохранения и копирования данных между ними. 【F:README.md†L17-L63】
- **Обмен данными** — фронтенд получает список графов, текущий снапшот и статус синхронизации через `/api/graph/*`. При ошибках переключается на встроенный демо-набор. 【F:src/App.tsx†L62-L270】

## Требования к инфраструктуре
| Компонент | Требование |
| --- | --- |
| Node.js | Версия 18 или выше (LTS). |
| npm | Поставляется с Node.js; используется для сборки и запуска. |
| Порты | `4000/tcp` для сервиса хранения (можно переопределить), `5173/tcp` для dev-сервера Vite. |
| Файловая система | Права записи в каталог `data/` для хранения `graph.db`; резервные копии размещайте на защищённом сетевом ресурсе. |
| Сеть | Внутренний сегмент или VPN. Для production рекомендуется HTTPS-терминация на уровне обратного прокси. |

## Модель данных
Сервис оперирует тремя типами сущностей. Знание структуры помогает планировать миграции и валидацию снапшотов.

### Домен (`DomainNode`)
| Поле | Назначение |
| --- | --- |
| `id` | Уникальный идентификатор (строка), используется в ссылках и дереве. |
| `name` | Отображаемое имя области. |
| `description` | Текстовое описание функций домена. |
| `children` | Массив дочерних доменов. Флаг `isCatalogRoot` помечает корневые папки, не попадающие в граф. 【F:src/data.ts†L1-L37】 |

### Модуль (`ModuleNode`)
| Поле | Назначение |
| --- | --- |
| `id`, `name` | Идентификатор и пользовательское имя модуля. |
| `description`, `localization` | Подробное описание и бизнес-контекст использования. |
| `domains` | Список идентификаторов доменов, в которых работает модуль. |
| `team`, `projectTeam` | Команда сопровождения и состав участников с ролями. |
| `productName` | Продукт или решение, в состав которого входит модуль. |
| `ridOwner` | Структура владельца прав на РИД (компания и подразделение). |
| `userStats` | Использование по компаниям (название и количество лицензий). |
| `status` | Жизненный цикл: `in-dev`, `production`, `deprecated`. |
| `repository`, `api`, `specificationUrl`, `apiContractsUrl`, `techDesignUrl`, `architectureDiagramUrl` | Ссылки на артефакты разработки. |
| `licenseServerIntegrated` | Признак интеграции с сервером лицензирования. |
| `libraries` | Перечень зависимостей с версиями. |
| `technologyStack`, `clientType`, `deploymentTool` | Технологическая платформа и среда исполнения. |
| `dependencies`, `produces`, `dataIn`, `dataOut` | Входные и выходные связи с другими сущностями, используемые графом и аналитикой. |
| `formula`, `metrics`, `nonFunctional` | Ключевые формулы, показатели качества и нефункциональные требования. 【F:src/data.ts†L39-L1019】 |

### Артефакт (`ArtifactNode`)
| Поле | Назначение |
| --- | --- |
| `id`, `name` | Уникальный идентификатор и имя артефакта данных. |
| `description` | Описание содержимого. |
| `domainId` | Домен, в рамках которого используется артефакт. |
| `producedBy` | Ссылка на модуль-источник (опционально). |
| `consumerIds` | Массив модулей-потребителей. |
| `dataType` | Тип данных (инженерные, потоковые, управляющие). |
| `sampleUrl` | Ссылка на пример или тестовый набор. 【F:src/data.ts†L1020-L1105】 |

## Подготовка и развертывание
1. Клонируйте репозиторий и установите зависимости: `npm install`.
2. Создайте системного пользователя без интерактивного входа, от имени которого будут запускаться сервисы.
3. Настройте директорию `data/` с правами записи для пользователя сервиса. При первом запуске файл `graph.db` создаётся автоматически.
4. Запустите сервис хранения: `npm run server`. Дополнительные параметры:
   - `PORT=5000 npm run server` — переопределение порта.
5. В отдельном процессе запустите фронтенд: `npm run dev` или сборку `npm run build && npm run preview`. Для одновременного запуска используйте `npm run dev:full`. 【F:README.md†L17-L79】
6. За обратным прокси настройте маршрутизацию `/api/graph/*` на порт сервиса хранения, а статические файлы — на собранный `dist/`.

## Управление окружениями и графами
- Список графов загружается при старте клиента; граф, где `isDefault = true`, активируется автоматически. Используйте его для подготовленного набора данных. 【F:src/App.tsx†L62-L170】
- Для создания нового графа воспользуйтесь административной формой или загрузите снапшот через API. После создания укажите понятное название и при необходимости отметьте `isDefault`.
- Переключение графов инициирует запрос `GET /api/graph/:id`, который возвращает модульные, доменные и артефактные данные вместе с раскладкой. Убедитесь, что API отвечает менее чем за 2–3 секунды, чтобы пользователь не потерял контекст. 【F:src/App.tsx†L114-L209】

## Операции со снапшотами
| Операция | Описание | Действия администратора |
| --- | --- | --- |
| Экспорт | Пользователь получает JSON с полем `version` и разделом `layout`. | Настройте регулярный экспорт и храните файлы в Git/объектном хранилище. Контролируйте версию схемы (`GRAPH_SNAPSHOT_VERSION`). 【F:src/components/GraphPersistenceControls.tsx†L17-L75】【F:src/types/graph.ts†L5-L24】 |
| Импорт | Валидация версии, структуры и количества сущностей, затем сохранение в базе. | Перед импортом проверьте совместимость версии и права доступа пользователя. Рекомендуется выполнять импорт на тестовом стенде. 【F:src/components/GraphPersistenceControls.tsx†L77-L145】 |
| Копирование | Перенос сущностей между графами внутри базы. | Подтвердите наличие графа-источника, определите, что именно переносится (домены/модули/артефакты), и уведомите пользователей о возможных конфликтах. 【F:src/components/GraphPersistenceControls.tsx†L147-L225】【F:src/services/graphStorage.ts†L186-L260】 |

### Версионирование и миграции
- Текущее значение `GRAPH_SNAPSHOT_VERSION = 1`. При изменении структуры данных подготовьте скрипт миграции, который обновит поле `version` в существующих JSON и добавит новые атрибуты. 【F:src/types/graph.ts†L5-L24】
- В репозитории поддерживайте каталог `migrations/` с инструкциями по преобразованию старых снапшотов.

## Администрирование данных
1. Ограничьте доступ к вкладке «Администрирование» с помощью аутентификации на уровне обратного прокси или VPN. Фронтенд предполагает, что доступ уже ограничен. 【F:src/components/AdminPanel.tsx†L1-L447】
2. Перед массовыми изменениями выполните экспорт снапшота и резервное копирование файла `graph.db`.
3. После сохранения формы проверьте логи сервиса хранения: успешная запись сопровождается сообщением `Saved snapshot for graph`. Ошибки структуры отображаются как `ValidationError`.
4. Для удаления сущностей удостоверьтесь, что связанные артефакты или модули не останутся без источника. Рекомендуется проводить аудит зависимостей через вкладку «Связи».

## Резервное копирование и восстановление
- **Ежедневные бэкапы**: копируйте файл `data/graph.db` на защищённый ресурс. Используйте ротацию минимум из 7 копий.
- **Оперативный бэкап**: экспортируйте JSON через интерфейс перед крупными изменениями или обновлением версии.
- **Восстановление**: остановите сервис, замените `graph.db` резервной копией, затем перезапустите. После запуска импортируйте последний JSON для проверки целостности.

## Мониторинг и диагностика
- Логи сервиса выводятся в STDOUT. Рекомендуется запускать через `pm2`, `systemd` или Docker с перенаправлением логов в централизованное хранилище.
- Фронтенд отображает статусы синхронизации (idle/saving/error) в панели «Управление снапшотом». При возникновении ошибок проверьте доступность `/api/graph` и сетевые политики. 【F:src/App.tsx†L182-L270】
- Клиент отменяет предыдущие запросы при переключении графов с помощью `AbortController`. Ошибки сети отображаются в UI и логируются в консоли браузера. 【F:src/App.tsx†L226-L313】
- Для аналитических панелей следите за корректностью вычислений: метрики берутся из данных модуля, поэтому при подозрениях проверяйте поля `metrics` и `nonFunctional`.

## Обновление версии приложения
1. Зафиксируйте текущее состояние: экспортируйте активный граф и сделайте копию `graph.db`.
2. Получите изменения из репозитория (`git pull`), выполните `npm install`, если изменился `package.json`.
3. Запустите тестовую сборку: `npm run build` и `npm run preview`, чтобы проверить UI.
4. При необходимости обновите конфигурацию инфраструктуры (порты, прокси) и перезапустите процессы. 【F:README.md†L47-L79】
5. Сверьте значение `GRAPH_SNAPSHOT_VERSION`. При изменении подготовьте миграцию и обновите существующие снапшоты. 【F:src/types/graph.ts†L5-L40】

## Типовые проблемы и способы решения
| Симптом | Возможная причина | Что сделать |
| --- | --- | --- |
| Панель показывает статус «Ошибка сохранения» | Недоступен сервис хранения или исчерпано место на диске | Проверьте лог сервиса (`npm run server`), убедитесь в наличии прав записи в `data/`. |
| Граф не загружается, отображаются демо-данные | Сбой в API или неверный URL | Проверьте маршрутизацию `/api/graph`, убедитесь в корректных переменных окружения на прокси. |
| Импорт завершается ошибкой версии | Несовместимый `GRAPH_SNAPSHOT_VERSION` | Запустите миграцию или обновите фронтенд/бэкенд до совместимой версии. |
| Дублируются сущности после копирования графов | Перенос выполнен без очистки целевого графа | Перед копированием экспортируйте данные, затем удалите дубликаты через административный интерфейс или SQL-скрипт. |

## Рекомендации по безопасности
- Размещайте сервис хранения в закрытом сегменте, доступном только по внутренним сетям или VPN.
- Ограничьте доступ к `graph.db` и JSON-экспорту — файлы содержат чувствительные сведения о системах и процессах.
- Регулярно запускайте `npm audit` и устанавливайте обновления зависимостей. Совмещайте с анализом отчётов линтера `npm run lint`. 【F:README.md†L65-L79】
- В production-публикации используйте HTTPS, корпоративный SSO и аудит действий (журналы прокси или SIEM).

## Онбординг и демо-данные
- Репозиторий содержит демо-набор доменов, модулей и артефактов, автоматически загружаемый при отсутствии соединения. Используйте его для обучения новых пользователей. 【F:src/data.ts†L1-L1105】
- Для подготовки кастомной демонстрации скопируйте существующий граф в новый, внесите изменения и поделитесь ссылкой на окружение.

## Контроль изменений
- Перед внедрением новой версии собирайте изменения в отдельной ветке и проводите код-ревью.
- Введите чек-лист деплоя: бэкап `graph.db`, проверка `npm audit`, smoke-тест интерфейса, уведомление пользователей.
- Документируйте каждое изменение структуры данных и храните инструкции по миграции рядом с кодом.
